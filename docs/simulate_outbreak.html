<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-04-27">

<title>HPAI Plume Modeling - Simulate Airborne Virus Introduction and Outbreak</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">HPAI Plume Modeling</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./simulate_outbreak.html" aria-current="page">
 <span class="menu-text">Simulate Outbreak</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./trace_emission_source.html">
 <span class="menu-text">Trace Emission</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/geoepi/EpiPlume"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Page Contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="toc-section-number">1</span>  Overview</a></li>
  <li><a href="#preliminary-setup" id="toc-preliminary-setup" class="nav-link" data-scroll-target="#preliminary-setup"><span class="toc-section-number">2</span>  Preliminary Setup</a>
  <ul class="collapse">
  <li><a href="#libraries" id="toc-libraries" class="nav-link" data-scroll-target="#libraries">Libraries</a></li>
  <li><a href="#core-functions" id="toc-core-functions" class="nav-link" data-scroll-target="#core-functions">Core Functions</a></li>
  <li><a href="#authentication" id="toc-authentication" class="nav-link" data-scroll-target="#authentication">Authentication</a></li>
  <li><a href="#api-registration" id="toc-api-registration" class="nav-link" data-scroll-target="#api-registration">API Registration</a></li>
  <li><a href="#osf-link" id="toc-osf-link" class="nav-link" data-scroll-target="#osf-link">OSF Link</a></li>
  </ul></li>
  <li><a href="#read-configuration-parameters" id="toc-read-configuration-parameters" class="nav-link" data-scroll-target="#read-configuration-parameters"><span class="toc-section-number">3</span>  Read Configuration Parameters</a></li>
  <li><a href="#create-study-area" id="toc-create-study-area" class="nav-link" data-scroll-target="#create-study-area"><span class="toc-section-number">4</span>  Create Study Area</a>
  <ul class="collapse">
  <li><a href="#flock-size-at-source-farm" id="toc-flock-size-at-source-farm" class="nav-link" data-scroll-target="#flock-size-at-source-farm">flock size at source farm</a></li>
  <li><a href="#plot-study-area" id="toc-plot-study-area" class="nav-link" data-scroll-target="#plot-study-area">Plot Study Area</a></li>
  </ul></li>
  <li><a href="#simulate-outbreak" id="toc-simulate-outbreak" class="nav-link" data-scroll-target="#simulate-outbreak"><span class="toc-section-number">5</span>  Simulate Outbreak</a>
  <ul class="collapse">
  <li><a href="#dates" id="toc-dates" class="nav-link" data-scroll-target="#dates">Dates</a></li>
  <li><a href="#seir-and-emission-estimates" id="toc-seir-and-emission-estimates" class="nav-link" data-scroll-target="#seir-and-emission-estimates">SEIR and Emission Estimates</a></li>
  <li><a href="#view-seir-dynamics" id="toc-view-seir-dynamics" class="nav-link" data-scroll-target="#view-seir-dynamics">View SEIR Dynamics</a></li>
  </ul></li>
  <li><a href="#plume-dispersion" id="toc-plume-dispersion" class="nav-link" data-scroll-target="#plume-dispersion"><span class="toc-section-number">6</span>  Plume Dispersion</a>
  <ul class="collapse">
  <li><a href="#run-plume-model" id="toc-run-plume-model" class="nav-link" data-scroll-target="#run-plume-model">Run plume model</a></li>
  <li><a href="#view-complete-simulated-dispersion" id="toc-view-complete-simulated-dispersion" class="nav-link" data-scroll-target="#view-complete-simulated-dispersion">View complete simulated dispersion</a></li>
  </ul></li>
  <li><a href="#calculate-concentration" id="toc-calculate-concentration" class="nav-link" data-scroll-target="#calculate-concentration"><span class="toc-section-number">7</span>  Calculate Concentration</a>
  <ul class="collapse">
  <li><a href="#view-concentration" id="toc-view-concentration" class="nav-link" data-scroll-target="#view-concentration">View Concentration</a></li>
  </ul></li>
  <li><a href="#spatiotemporal-modeling" id="toc-spatiotemporal-modeling" class="nav-link" data-scroll-target="#spatiotemporal-modeling"><span class="toc-section-number">8</span>  Spatiotemporal Modeling</a>
  <ul class="collapse">
  <li><a href="#construct-mesh" id="toc-construct-mesh" class="nav-link" data-scroll-target="#construct-mesh">Construct mesh</a></li>
  <li><a href="#combine-data" id="toc-combine-data" class="nav-link" data-scroll-target="#combine-data">Combine data</a></li>
  <li><a href="#mesh-projection" id="toc-mesh-projection" class="nav-link" data-scroll-target="#mesh-projection">Mesh projection</a></li>
  </ul></li>
  <li><a href="#organize-data" id="toc-organize-data" class="nav-link" data-scroll-target="#organize-data"><span class="toc-section-number">9</span>  Organize Data</a>
  <ul class="collapse">
  <li><a href="#individual-particles" id="toc-individual-particles" class="nav-link" data-scroll-target="#individual-particles">Individual particles</a></li>
  <li><a href="#concentration" id="toc-concentration" class="nav-link" data-scroll-target="#concentration">Concentration</a></li>
  <li><a href="#combine-stacks" id="toc-combine-stacks" class="nav-link" data-scroll-target="#combine-stacks">Combine Stacks</a></li>
  </ul></li>
  <li><a href="#run-joint-spatiotemporal-model" id="toc-run-joint-spatiotemporal-model" class="nav-link" data-scroll-target="#run-joint-spatiotemporal-model"><span class="toc-section-number">10</span>  Run Joint Spatiotemporal Model</a></li>
  <li><a href="#model-results" id="toc-model-results" class="nav-link" data-scroll-target="#model-results"><span class="toc-section-number">11</span>  Model Results</a>
  <ul class="collapse">
  <li><a href="#get-latent-fields" id="toc-get-latent-fields" class="nav-link" data-scroll-target="#get-latent-fields">Get Latent Fields</a></li>
  <li><a href="#view-fields" id="toc-view-fields" class="nav-link" data-scroll-target="#view-fields">View Fields</a></li>
  <li><a href="#particle-probabilty" id="toc-particle-probabilty" class="nav-link" data-scroll-target="#particle-probabilty">Particle Probabilty</a></li>
  <li><a href="#particle-concentration" id="toc-particle-concentration" class="nav-link" data-scroll-target="#particle-concentration">Particle Concentration</a></li>
  </ul></li>
  <li><a href="#farm-introduction-probability" id="toc-farm-introduction-probability" class="nav-link" data-scroll-target="#farm-introduction-probability"><span class="toc-section-number">12</span>  Farm Introduction Probability</a>
  <ul class="collapse">
  <li><a href="#probability-at-farms" id="toc-probability-at-farms" class="nav-link" data-scroll-target="#probability-at-farms">Probability at farms</a></li>
  </ul></li>
  <li><a href="#secondary-outbreak" id="toc-secondary-outbreak" class="nav-link" data-scroll-target="#secondary-outbreak"><span class="toc-section-number">13</span>  Secondary Outbreak</a>
  <ul class="collapse">
  <li><a href="#seir-model-for-secondary-ourbreak" id="toc-seir-model-for-secondary-ourbreak" class="nav-link" data-scroll-target="#seir-model-for-secondary-ourbreak">SEIR model for secondary ourbreak</a></li>
  <li><a href="#view-outbreak-dynamics" id="toc-view-outbreak-dynamics" class="nav-link" data-scroll-target="#view-outbreak-dynamics">View outbreak dynamics</a></li>
  </ul></li>
  <li><a href="#write-simulation-result" id="toc-write-simulation-result" class="nav-link" data-scroll-target="#write-simulation-result"><span class="toc-section-number">14</span>  Write Simulation Result</a></li>
  <li><a href="#closing" id="toc-closing" class="nav-link" data-scroll-target="#closing"><span class="toc-section-number">15</span>  Closing</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Simulate Airborne Virus Introduction and Outbreak</h1>
  <div class="quarto-categories">
    <div class="quarto-category">R</div>
    <div class="quarto-category">HPAI</div>
    <div class="quarto-category">Spatiotemporal</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 27, 2025</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<style type="text/css">

body, td {
   font-size: 13pt;
}
code.r{
  font-size: 9pt;
}
pre {
  font-size: 11pt
}
</style>
<section id="overview" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="overview"><span class="header-section-number">1</span> Overview</h2>
<p>This script provides a conceptual workflow that simulates farm locations, performs atmospheric dispersion modeling from a source farm (aka, <em>plume</em> modeling), analyzes the plume results in a spatial temporal model, and then identifies the simulated farms most vulnerable to airborne virus introduction. The results from this <em>forward</em> simulation are analysed in a second script, <a href="https://geoepi.github.io/EpiPlume/trace_emission_source.html">available here</a>, in an attempt to identify the source farms using only the information from the secondarily infected farms simulated here.</p>
</section>
<section id="preliminary-setup" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="preliminary-setup"><span class="header-section-number">2</span> Preliminary Setup</h2>
<section id="libraries" class="level3">
<h3 class="anchored" data-anchor-id="libraries">Libraries</h3>
<p>This workflow uses the <strong>renv</strong> package for package version and environmental management. The <code>renv.lock</code> file is included to facilitate package installation. See, <em>renv::restore()</em>.</p>
<div class="cell">

</div>
</section>
<section id="core-functions" class="level3">
<h3 class="anchored" data-anchor-id="core-functions">Core Functions</h3>
<p>Custom functions</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">here</span>(<span class="st">"R/utilities.R"</span>))</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source_dir</span>(<span class="fu">here</span>(<span class="st">"R"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="authentication" class="level3">
<h3 class="anchored" data-anchor-id="authentication">Authentication</h3>
<p>User credentials to access data repository and API resources.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>authentications <span class="ot">&lt;-</span> yaml<span class="sc">::</span><span class="fu">read_yaml</span>(<span class="fu">here</span>(<span class="st">"local"</span>, <span class="st">"secrets.yaml"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="api-registration" class="level3">
<h3 class="anchored" data-anchor-id="api-registration">API Registration</h3>
<p><strong>Stadia</strong> maps are used for backgrounds.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">register_stadiamaps</span>(<span class="at">key =</span> authentications<span class="sc">$</span>stadi_api)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="osf-link" class="level3">
<h3 class="anchored" data-anchor-id="osf-link">OSF Link</h3>
<p>Models and data generated from this script are stored at the <em>Open Science Framework (OSF)</em> for remote access. See, this <a href="https://osf.io/98hmt/"><strong>OSF Project:</strong></a></p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">osf_auth</span>(authentications<span class="sc">$</span>osf_token) <span class="co"># for write/admin privileges</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Registered PAT from the provided token</code></pre>
</div>
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>osf_project_demo <span class="ot">&lt;-</span> <span class="fu">osf_retrieve_node</span>(<span class="st">"https://osf.io/su4yz/"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>osf_project_demo<span class="sc">$</span>name <span class="co"># scratch directory on OSF EpiPlume project</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Demonstration Data"</code></pre>
</div>
</div>
</section>
</section>
<section id="read-configuration-parameters" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="read-configuration-parameters"><span class="header-section-number">3</span> Read Configuration Parameters</h2>
<p>Parameters for epidemiological and spatial analyses are recorded in configuration files. Loading the demonstration config file, which can be viewed here: <a href="https://github.com/geoepi/EpiPlume/blob/main/config/demo_2025-04-21.yaml">Demo Configuration Parameters</a>.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>cfg <span class="ot">&lt;-</span> yaml<span class="sc">::</span><span class="fu">read_yaml</span>(<span class="fu">here</span>(<span class="st">"config"</span>, <span class="st">"demo_2025-04-21.yaml"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="create-study-area" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="create-study-area"><span class="header-section-number">4</span> Create Study Area</h2>
<p>From a given lat-long, the <em>define_study_domain()</em> function constructs a surrounding square grid at a specified extent and resolution to define a study area. The function optionally generates a specified number of simulated farms. The farms are randomly assigned within the study, based on chicken density estimated in the Gridded Livestock of the World Database <a href="https://www.fao.org/land-water/land/land-governance/land-resources-planning-toolbox/category/details/fr/c/1236449/">(source)</a>. The more chickens at a location, the higher the probability that a random farm be placed there. The random farms are assigned a random flock size based on a possible range specified in the config file.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>study_area_args <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  cfg<span class="sc">$</span>domain, <span class="co"># from config</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed      =</span> <span class="dv">123</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_flock =</span> <span class="dv">15000</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_flock =</span> <span class="dv">50000</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>study_area <span class="ot">&lt;-</span> <span class="fu">exec</span>(define_study_domain, <span class="sc">!!!</span>study_area_args)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co"># attributes</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(study_area)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>List of 4
 $ projection  : chr "+proj=utm +zone=16 +north +datum=WGS84 +units=m +no_defs"
 $ grid        :S4 class 'SpatRaster' [package "terra"]
 $ source_point:S4 class 'SpatVector' [package "terra"]
 $ farm_locs   :S4 class 'SpatVector' [package "terra"]</code></pre>
</div>
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># flock sizes</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(study_area<span class="sc">$</span>farm_locs<span class="sc">$</span>flock)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 15861 49799</code></pre>
</div>
</div>
<section id="flock-size-at-source-farm" class="level3">
<h3 class="anchored" data-anchor-id="flock-size-at-source-farm">flock size at source farm</h3>
<p>For the demo, the center most farm used in defining the study area is considered the source of pathogen emission. The flock size is need for that location to estimate emission.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>source_flock_n <span class="ot">&lt;-</span> <span class="fu">values</span>(study_area<span class="sc">$</span>farm_locs) <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(farm <span class="sc">==</span> <span class="st">"source"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(flock)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>source_flock_n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">flock</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">19998</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="plot-study-area" class="level3">
<h3 class="anchored" data-anchor-id="plot-study-area">Plot Study Area</h3>
<p>The source is the center most triangle, other farms are shown as circles.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_grid</span>(study_area<span class="sc">$</span>grid, <span class="at">source_loc =</span> study_area<span class="sc">$</span>farm_locs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-domian" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="simulate_outbreak_files/figure-html/fig-domian-1.png" class="img-fluid figure-img" width="768"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: Study area for analysis with simulated farms as indicated in legend.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="simulate-outbreak" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="simulate-outbreak"><span class="header-section-number">5</span> Simulate Outbreak</h2>
<section id="dates" class="level3">
<h3 class="anchored" data-anchor-id="dates">Dates</h3>
<p>Random dates for initial infection and virus emission from the source farm. Assuming detection occurs 5 to 20 days after outbreaks start. That is, when workers notice that chicken death rates are exceeding the normal background rate.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>sim_dates <span class="ot">&lt;-</span> <span class="fu">random_infect_dates</span>(<span class="at">year =</span> <span class="dv">2020</span>, <span class="at">month =</span> <span class="dv">5</span>, <span class="at">seed=</span><span class="dv">1976</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>sim_dates</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$release_date
[1] "2020-05-27"

$infection_date
[1] "2020-05-15"</code></pre>
</div>
</div>
</section>
<section id="seir-and-emission-estimates" class="level3">
<h3 class="anchored" data-anchor-id="seir-and-emission-estimates">SEIR and Emission Estimates</h3>
<p>Run SEIR model for source farm. There are a ton of parameter assumptions here to discuss. Brief explanations are provided with the <a href="https://github.com/geoepi/EpiPlume/blob/main/config/demo_2025-04-21.yaml">config file (linked here)</a>, but far too much to include in this draft workflow.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># virus decay, rate of decreasing viability</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>halflife <span class="ot">&lt;-</span> <span class="fu">calculate_half_life</span>(<span class="at">viability_days =</span> cfg<span class="sc">$</span>virus<span class="sc">$</span>viability_hours<span class="sc">/</span><span class="dv">24</span>, <span class="co"># convert hours to days</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">viability_threshold =</span> cfg<span class="sc">$</span>virus<span class="sc">$</span>viability_threshold)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>args <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta       =</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>beta,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sigma      =</span> <span class="dv">1</span> <span class="sc">/</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>sigma, <span class="co"># per/day</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma      =</span> <span class="dv">1</span> <span class="sc">/</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>gamma, <span class="co"># per/day</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">qV         =</span> cfg<span class="sc">$</span>virus<span class="sc">$</span>qV,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">Vh         =</span> cfg<span class="sc">$</span>poultry<span class="sc">$</span>house_vol,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q          =</span> cfg<span class="sc">$</span>poultry<span class="sc">$</span>Q_m3_h <span class="sc">*</span> <span class="dv">24</span>, <span class="co"># to days</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">lamd       =</span> <span class="fu">log</span>(<span class="dv">2</span>) <span class="sc">/</span> halflife, <span class="co"># virus decay</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">flock_size =</span> source_flock_n<span class="sc">$</span>flock, <span class="co"># flock size at source farm</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ei         =</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>Ei,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ii         =</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>Ii,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ri         =</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>Ri,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">Vi         =</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>Vi,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">sim_days   =</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>sim_days,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">infect_date =</span> sim_dates<span class="sc">$</span>infection_date <span class="co"># initial infection</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>seir_out <span class="ot">&lt;-</span> <span class="fu">do.call</span>(model_seir_shedding, args)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Get rate on day of emission</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># values for emission day</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>source_rate <span class="ot">&lt;-</span> seir_out <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(datetime <span class="sc">&gt;=</span> sim_dates<span class="sc">$</span>release_date <span class="sc">&amp;</span> datetime <span class="sc">&lt;</span> (sim_dates<span class="sc">$</span>release_date <span class="sc">+</span> <span class="fu">days</span>(<span class="dv">1</span>))) </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># range day of release</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(source_rate<span class="sc">$</span>V)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 30.43649 48.47731</code></pre>
</div>
</div>
</section>
<section id="view-seir-dynamics" class="level3">
<h3 class="anchored" data-anchor-id="view-seir-dynamics">View SEIR Dynamics</h3>
<p>Top panel is SEIR result, bottom is estimated virus output at the the source farm.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ode_shed_dynamics</span>(seir_out, <span class="at">date_axis =</span> <span class="cn">TRUE</span>, <span class="at">vline =</span> sim_dates<span class="sc">$</span>release_date, <span class="at">vline_text =</span> <span class="st">"Emission"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="simulate_outbreak_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="960"></p>
</div>
</div>
</section>
</section>
<section id="plume-dispersion" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="plume-dispersion"><span class="header-section-number">6</span> Plume Dispersion</h2>
<p>A <a href="https://www.ready.noaa.gov/HYSPLIT.php">HYSPLIT</a> model is constructed based on the simulated outbreak and source farm emission dynamics. The <a href="https://github.com/rich-iannone/splitr"><strong>splitR</strong> package</a> is used to call a HYSPLIT executable from R.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>arbitrary_hour <span class="ot">&lt;-</span> <span class="dv">12</span> <span class="co"># noon</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>simulated_realease_dt <span class="ot">&lt;-</span> <span class="fu">ymd_hm</span>(<span class="fu">paste0</span>(sim_dates<span class="sc">$</span>release_date, <span class="st">" "</span>, <span class="fu">sprintf</span>(<span class="st">"%02d:00"</span>, arbitrary_hour)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="run-plume-model" class="level3">
<h3 class="anchored" data-anchor-id="run-plume-model">Run plume model</h3>
<p>The <em>wrap_plume_model()</em> function saves the plume model locally, however, a copy is also saved to OSF. There are a ton of parameter assumptions here to discuss. Brief explanations are provided with the <a href="https://github.com/geoepi/EpiPlume/blob/main/config/demo_2025-04-21.yaml">config file (linked here)</a>, but its too much for this draft workflow.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>plume_model <span class="ot">&lt;-</span> <span class="fu">wrap_plume_model</span>(cfg, <span class="co"># configuration file</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">plume_name =</span> <span class="st">"sim_demo"</span>, <span class="co"># name/label</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">rate =</span> <span class="fu">mean</span>(source_rate<span class="sc">$</span>V), <span class="co"># rate from simulated outbreak</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">release_start =</span> simulated_realease_dt, <span class="co"># release from source farm</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                                <span class="at">release_end =</span> simulated_realease_dt <span class="sc">+</span> <span class="fu">hours</span>(<span class="dv">1</span>), <span class="co"># hour long</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>                                <span class="at">start_time =</span> simulated_realease_dt, <span class="co"># dispersion time same as emission</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>                                <span class="at">end_time =</span> simulated_realease_dt <span class="sc">+</span> <span class="fu">hours</span>(<span class="dv">24</span>) <span class="co"># dispersion end</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>                                )</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co"># copy to OSF for others to access (~500kb)</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="fu">osf_upload</span>(osf_project_demo, <span class="at">path =</span> <span class="fu">here</span>(<span class="st">"local/demo_run/plume/sim_demo_model.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Download plume model from OSF</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>osf_id <span class="ot">&lt;-</span> osf_project_demo <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">osf_ls_files</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(name <span class="sc">==</span> <span class="st">"sim_demo_model.rds"</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="fu">osf_download</span>(osf_id,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">path =</span> <span class="fu">here</span>(<span class="st">"local/temp"</span>),</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">conflicts =</span> <span class="st">"overwrite"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Read plume model</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>plume_model <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">here</span>(<span class="st">"local/temp/sim_demo_model.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="view-complete-simulated-dispersion" class="level3">
<h3 class="anchored" data-anchor-id="view-complete-simulated-dispersion">View complete simulated dispersion</h3>
<p>Full extent of plume</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_grid2</span>(study_area<span class="sc">$</span>grid, plume_model<span class="sc">$</span>disp_df, <span class="at">group_col =</span> <span class="st">"particle_i"</span>, <span class="at">vector_type =</span> <span class="st">"point"</span>, <span class="at">grid_cut=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="simulate_outbreak_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Plume extent within study area</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_grid2</span>(study_area<span class="sc">$</span>grid, plume_model<span class="sc">$</span>disp_df, <span class="at">group_col =</span> <span class="st">"particle_i"</span>, <span class="at">vector_type =</span> <span class="st">"point"</span>, <span class="at">grid_cut=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="simulate_outbreak_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>A quick, low-weight animation as a spot check of time.</p>
<pre data-rfig.width="10," data-fig.height="10," data-warning="FALSE," data-message="FALSE"><code>
animate_disp &lt;- animate_plume_simple(traj_data = plume_model$disp_df, 
                                     group_col = "particle_i", 
                                     point_size = 0.5, 
                                     source_loc=cfg$domain$source_origin)

animate_disp</code></pre>
</section>
</section>
<section id="calculate-concentration" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="calculate-concentration"><span class="header-section-number">7</span> Calculate Concentration</h2>
<p>The <em>calculate_particle_concentration()</em> utilizes HYSPLIT estimated particles to calculate the particles per m3 hour. Limiting analysis to first 6 hours, beyond that time the plume is outside the study area.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>concentration_lst <span class="ot">&lt;-</span> <span class="fu">calculate_particle_concentration</span>(<span class="at">plume_table=</span>plume_model<span class="sc">$</span>disp_df, </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">raster_grid =</span> study_area<span class="sc">$</span>grid,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">voxel_height =</span> <span class="dv">50</span>, <span class="co"># height (m)</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">max_hour =</span> <span class="dv">6</span>) <span class="co"># maximum hour to use</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="view-concentration" class="level3">
<h3 class="anchored" data-anchor-id="view-concentration">View Concentration</h3>
<p>Viewing the first hour only.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>check_hour <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">map_grid</span>(study_area<span class="sc">$</span>grid, </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">source_loc =</span> study_area<span class="sc">$</span>source_point, </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">concentration_raster =</span> concentration_lst<span class="sc">$</span>concentration_stack[[check_hour]],</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">map_type =</span> <span class="st">"stamen_toner_lite"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>ℹ © Stadia Maps © Stamen Design © OpenMapTiles © OpenStreetMap contributors.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Coordinate system already present. Adding new coordinate system, which will
replace the existing one.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="simulate_outbreak_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Get concentration estimates for later analysis.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>concentration_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(concentration_lst<span class="sc">$</span>concentration_stack, <span class="at">xy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>conc_melt <span class="ot">&lt;-</span> reshape2<span class="sc">::</span><span class="fu">melt</span>(concentration_df, <span class="fu">c</span>(<span class="st">"x"</span>,<span class="st">"y"</span>))</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>conc_melt<span class="sc">$</span>hour <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">sub</span>(<span class="st">"^hour_"</span>, <span class="st">""</span>, conc_melt<span class="sc">$</span>variable))</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>conc_melt <span class="ot">&lt;-</span> conc_melt <span class="sc">%&gt;%</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hour =</span> <span class="fu">as.integer</span>(<span class="fu">sub</span>(<span class="st">"^hour_"</span>, <span class="st">""</span>, variable)),</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">concen =</span> value) <span class="sc">%&gt;%</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(variable, value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="spatiotemporal-modeling" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="spatiotemporal-modeling"><span class="header-section-number">8</span> Spatiotemporal Modeling</h2>
<p>The primary objective of spatial modeling is to account for spatial (<span class="math inline">s</span>) and temporal (<span class="math inline">t</span>) latency (error, variability) and uncertainty in HYSPLIT outputs. This <em>smoothed</em> results and enables uncertainty estimation. Just as importantly, developing the the HYSPLIT outputs to a spatiotemporal model allow for incorporating other variables, to include climate, land cover, farm specific biosecurity factors, and genetic samples to name a few.</p>
<p>The modeling framework here is a two-tiered joint model that concurrently estimates particle counts (tier 1, <span class="math inline">{y}_{1st}</span>) and mass concentration (tier 2, <span class="math inline">{y}_{2st}</span>) while accounting for correlated spatial and temporal factors as well as their interaction. These analyses follow a point-process framework, however concentration points in <span class="math inline">{y}_{2st}</span> actually represent an area (grid cell). To help account for errors created when aggregating particles to grid cells, the random spatial field from the individual particles is shared with tier 2. In essence, individual particles act as a <em>predictor</em> or <em>covariate</em> for the cell-level concentration estimates.</p>
<p>As a joint model with two likelihoods, our response variable was specified as a bivariate matrix (i.e., <span class="math inline">Y = c({y}_{1st}, {y}_{2st})</span> where the first column was coded to indicate particle occurrence (1) or non-occurrence (0) such that,</p>
<p><span class="math display">
  \textit{y}_{1st} =
    \begin{cases}
      1, &amp; \text{particle present} \\
      0, &amp; \text{no particle present} \\
    \end{cases}       
</span></p>
<p>The second tier component modeled concentration where values were known, with</p>
<p><span class="math display">
  \textit{y}_{2st} =
    \begin{cases}
      NA, &amp; \text{concentration unknown} \\
      concentration, &amp; \text{estimated concentration values}
    \end{cases}
</span></p>
<p>To model airborne particulate matter using a <strong>binomial-gamma joint likelihood</strong> was used to separately represent particle probability and concentration. For particle detection (<span class="math inline">y_1st</span>) was modeled using a Bernoulli distribution, while the latent concentration of particulate matter (<span class="math inline">y_2st</span>) was modeled with a Gamma distribution:</p>
<p><span class="math display">
y_{1st} \sim \text{Bernoulli}(\pi_{st})
</span></p>
<p><span class="math display">
y_{2st} \sim \text{Gamma}(a_{st}, b_{st})
</span></p>
<p>where <span class="math inline">\pi_{st}</span> denotes the probability of detecting particulate matter at spatial location <span class="math inline">s</span> and time <span class="math inline">t</span>, and <span class="math inline">a_{st}</span> and <span class="math inline">b_{st}</span> are the Gamma shape and rate parameters, with mean <span class="math inline">\mu_{st} = a_{st} / b_{st}</span>.</p>
<p>The particle probability linear predictor was defined as:</p>
<p><span class="math display">
\text{logit}(\pi_{st}) = \alpha^1 + \zeta_{st}^1 + \lambda S_{st}
</span></p>
<p>The concentration linear predictor was defined as:</p>
<p><span class="math display">
\log(\mu_{st}) = \alpha^2 + \zeta_{st}^2 + \frac{1}{\lambda} S_{st}
</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\alpha^1</span> and <span class="math inline">\alpha^2</span> are intercepts,</li>
<li><span class="math inline">\zeta_{st}</span> represents tier-specific spatial random effects,</li>
<li><span class="math inline">S_{st}</span> is a shared spatiotemporal effect,</li>
<li><span class="math inline">\lambda</span> is a scaling parameter linking the probability and concentration models.</li>
</ul>
<section id="construct-mesh" class="level3">
<h3 class="anchored" data-anchor-id="construct-mesh">Construct mesh</h3>
<p>Construct a tessellated mesh to define the study area</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>mesh.dom <span class="ot">&lt;-</span> <span class="fu">construct_mesh</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid_raster =</span> study_area<span class="sc">$</span>grid,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">farm_locs =</span> study_area<span class="sc">$</span>farm_locs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Quick check</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mesh.dom$n # number of nodes</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_mesh</span>(mesh.dom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="simulate_outbreak_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="576"></p>
</div>
</div>
</section>
<section id="combine-data" class="level3">
<h3 class="anchored" data-anchor-id="combine-data">Combine data</h3>
<p>Indexing all data to ensure all time steps (hours 1-6) are represented and inserting NA where data is unknown.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>comb_data_in <span class="ot">&lt;-</span> <span class="fu">replicate_data_timesteps</span>(<span class="at">grid_raster =</span> study_area<span class="sc">$</span>grid,</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">farm_locs =</span> study_area<span class="sc">$</span>farm_locs,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">concen_data =</span> conc_melt,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">scale_concentration =</span> <span class="fl">1e6</span>,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">plume_model =</span> plume_model,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">mesh =</span> mesh.dom,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">max_hour =</span> <span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="mesh-projection" class="level3">
<h3 class="anchored" data-anchor-id="mesh-projection">Mesh projection</h3>
<p>Aligning, matching, or <em>projecting</em> data to the mesh.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># flat prior based on study area width</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>width_m <span class="ot">&lt;-</span> <span class="fu">dim</span>(study_area<span class="sc">$</span>grid)[<span class="dv">1</span>]<span class="sc">*</span><span class="fu">res</span>(study_area<span class="sc">$</span>grid)[<span class="dv">1</span>]<span class="sc">/</span><span class="dv">3</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>sp_indices_dens <span class="ot">&lt;-</span> <span class="fu">project_to_mesh</span>(<span class="at">comb_data =</span> comb_data_in,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">prior.range=</span><span class="fu">c</span>(width_m, <span class="fl">0.01</span>),</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">prior.sigma=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.01</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="organize-data" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="organize-data"><span class="header-section-number">9</span> Organize Data</h2>
<p>Organizing all model inputs as <em>list()</em> objects. This is needed because data within and between model tiers are different dimensions (i.e., won’t fit in a common data frame).</p>
<section id="individual-particles" class="level3">
<h3 class="anchored" data-anchor-id="individual-particles">Individual particles</h3>
<p>Organize tier 1 data for individual particles.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>comb_data_in<span class="sc">$</span>set_type <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.factor</span>(comb_data_in<span class="sc">$</span>set)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>dens.lst <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">c</span>(sp_indices_dens<span class="sc">$</span>field.sp<span class="fl">.1</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">list</span>(<span class="at">intercept1 =</span> <span class="dv">1</span>)), </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">list</span>(<span class="at">height =</span> comb_data_in[,<span class="st">"height"</span>],</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hour_step.1 =</span> comb_data_in[,<span class="st">"hour"</span>],</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hour_step.2 =</span> comb_data_in[,<span class="st">"hour"</span>],</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hour_step.3 =</span> comb_data_in[,<span class="st">"hour"</span>],</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">set_type =</span> comb_data_in[,<span class="st">"set_type"</span>])</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>comb_data_in<span class="sc">$</span>Yd <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(comb_data_in<span class="sc">$</span>set <span class="sc">==</span> <span class="st">"particle"</span>, <span class="dv">1</span>, </span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">ifelse</span>(comb_data_in<span class="sc">$</span>set <span class="sc">==</span> <span class="st">"node"</span>, <span class="dv">0</span>, <span class="cn">NA</span>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>dens.stk <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">data =</span> <span class="fu">list</span>(<span class="at">Y =</span> comb_data_in<span class="sc">$</span>Yd),</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">A =</span> <span class="fu">list</span>(sp_indices_dens<span class="sc">$</span>A.mat, <span class="dv">1</span>), </span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>                           <span class="at">effects =</span> dens.lst,   </span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tag =</span> <span class="st">"dens.0"</span>)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>j.dens.stk <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">data =</span> <span class="fu">list</span>(<span class="at">Y =</span> <span class="fu">cbind</span>(comb_data_in<span class="sc">$</span>Yd, <span class="cn">NA</span>), <span class="at">link =</span> <span class="dv">1</span>),</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">A =</span> <span class="fu">list</span>(sp_indices_dens<span class="sc">$</span>A.mat, <span class="dv">1</span>), </span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>                           <span class="at">effects =</span> dens.lst,   </span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tag =</span> <span class="st">"dens.0"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="concentration" class="level3">
<h3 class="anchored" data-anchor-id="concentration">Concentration</h3>
<p>Organize tier 2 data for aggregate particle measures (concentration).</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>conc.lst <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">c</span>(sp_indices_dens<span class="sc">$</span>field.sp<span class="fl">.2</span>,</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">list</span>(<span class="at">intercept2 =</span> <span class="dv">1</span>)), </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">list</span>(<span class="at">x =</span> comb_data_in[,<span class="st">"x"</span>],</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hour_step.1 =</span> comb_data_in[,<span class="st">"hour"</span>],</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hour_step.2 =</span> comb_data_in[,<span class="st">"hour"</span>],</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hour_step.3 =</span> comb_data_in[,<span class="st">"hour"</span>])</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>comb_data_in<span class="sc">$</span>concen[comb_data_in<span class="sc">$</span>concen <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="fl">1e-6</span> <span class="co"># gamma distributed</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>concen.stk <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">data =</span> <span class="fu">list</span>(<span class="at">Y =</span> comb_data_in<span class="sc">$</span>concen),</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">A =</span> <span class="fu">list</span>(sp_indices_dens<span class="sc">$</span>A.mat, <span class="dv">1</span>), </span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>                           <span class="at">effects =</span> conc.lst,   </span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tag =</span> <span class="st">"conc.0"</span>)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>j.conc.stk <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">data =</span> <span class="fu">list</span>(<span class="at">Y =</span> <span class="fu">cbind</span>(<span class="cn">NA</span>, comb_data_in<span class="sc">$</span>concen), <span class="at">link =</span> <span class="dv">2</span>),</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">A =</span> <span class="fu">list</span>(sp_indices_dens<span class="sc">$</span>A.mat, <span class="dv">1</span>), </span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>                           <span class="at">effects =</span> conc.lst,   </span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tag =</span> <span class="st">"conc.0"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="combine-stacks" class="level3">
<h3 class="anchored" data-anchor-id="combine-stacks">Combine Stacks</h3>
<p>Combine the probability and and concentration data.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>joint.stack <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(j.dens.stk, j.conc.stk)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="run-joint-spatiotemporal-model" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="run-joint-spatiotemporal-model"><span class="header-section-number">10</span> Run Joint Spatiotemporal Model</h2>
<p>The <em>run_joint_spatiotemporal()</em> is a wrapper function to facilitate model fitting with <a href="https://www.r-inla.org/">r-INLA</a>. The model formula and execution can be viewed here: <a href="https://github.com/geoepi/EpiPlume/blob/main/R/run_joint_spatiotemporal.R"><strong>Model Details</strong></a></p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>bin_gamma_model <span class="ot">&lt;-</span> <span class="fu">run_joint_spatiotemporal</span>(<span class="at">field.sp.1 =</span> sp_indices_dens<span class="sc">$</span>field.sp<span class="fl">.1</span>,</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">field.sp.2 =</span> sp_indices_dens<span class="sc">$</span>field.sp<span class="fl">.2</span>,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">spde_prior =</span> sp_indices_dens<span class="sc">$</span>spde0,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">est.stk =</span> joint.stack,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">verbose =</span><span class="cn">TRUE</span>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co"># copy to OSF for others to access (~112mb)</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="fu">osf_upload</span>(osf_project_demo, <span class="at">path =</span> <span class="fu">here</span>(<span class="st">"local/assets/bg_model_2025-04-26.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Download pre-run from OSF</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>osf_id <span class="ot">&lt;-</span> osf_project_demo <span class="sc">%&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">osf_ls_files</span>() <span class="sc">%&gt;%</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(name <span class="sc">==</span> <span class="st">"bg_model_2025-04-26.rds"</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="fu">osf_download</span>(osf_id,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">path =</span> <span class="fu">here</span>(<span class="st">"local/temp"</span>),</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">conflicts =</span> <span class="st">"overwrite"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Read spatiotemporal model</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>bin_gamma_model <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"local/temp/bg_model_2025-04-26.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="model-results" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="model-results"><span class="header-section-number">11</span> Model Results</h2>
<p>Inspecting a few spatiotemporal model outputs.</p>
<section id="get-latent-fields" class="level3">
<h3 class="anchored" data-anchor-id="get-latent-fields">Get Latent Fields</h3>
<p>The <em>get_spatial_rf()</em> function spatial</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>random_latent_field <span class="ot">&lt;-</span> <span class="fu">get_spatial_rf</span>(<span class="at">model =</span> bin_gamma_model,</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">field_sp =</span> sp_indices_dens<span class="sc">$</span>field.sp<span class="fl">.1</span>,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">raster_template =</span> study_area<span class="sc">$</span>grid,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">mesh =</span> mesh.dom</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="view-fields" class="level3">
<h3 class="anchored" data-anchor-id="view-fields">View Fields</h3>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_latent_stack</span>(<span class="at">rast_stack=</span>random_latent_field,</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">farm_locs =</span> study_area<span class="sc">$</span>farm_locs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="simulate_outbreak_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="960"></p>
</div>
</div>
</section>
<section id="particle-probabilty" class="level3">
<h3 class="anchored" data-anchor-id="particle-probabilty">Particle Probabilty</h3>
<p>Extracting the probability estimates for all locations in the study area.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>particle_probs <span class="ot">&lt;-</span> <span class="fu">extract_stmodel_estimates</span>(<span class="at">model =</span> bin_gamma_model,</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">stack =</span> joint.stack,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">stack_targ =</span> <span class="st">"dens.0"</span>,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">match_data =</span> comb_data_in,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">grid_label =</span> <span class="st">"concen"</span>,</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">raster_template =</span> study_area<span class="sc">$</span>grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_prob_stack</span>(particle_probs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="simulate_outbreak_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid" width="960"></p>
</div>
</div>
</section>
<section id="particle-concentration" class="level3">
<h3 class="anchored" data-anchor-id="particle-concentration">Particle Concentration</h3>
<p>Extracting estimated concentrations for all locations in the study area.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>particle_conc <span class="ot">&lt;-</span> <span class="fu">extract_stmodel_estimates</span>(<span class="at">model =</span> bin_gamma_model,</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">stack =</span> joint.stack,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">stack_targ =</span> <span class="st">"conc.0"</span>,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">match_data =</span> comb_data_in,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">grid_label =</span> <span class="st">"concen"</span>,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">raster_template =</span> study_area<span class="sc">$</span>grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_conc_stack</span>(particle_conc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="simulate_outbreak_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Optionally, can convert particle density to mass concentration (g/m3) using <em>convert_particle_to_mass_concentration()</em>.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>mass_conc_stack <span class="ot">&lt;-</span> particle_conc</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">values</span>(mass_conc_stack) <span class="ot">&lt;-</span> <span class="fu">convert_particle_to_mass_concentration</span>(<span class="at">concentration_particles_m3 =</span> <span class="fu">values</span>(mass_conc_stack),</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">pdiam_um =</span> cfg<span class="sc">$</span>plume<span class="sc">$</span>pdiam,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">density_g_cm3 =</span> cfg<span class="sc">$</span>plume<span class="sc">$</span>density,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">shape_factor =</span> cfg<span class="sc">$</span>plume<span class="sc">$</span>shape_factor,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="at">output_units =</span> <span class="st">"g/m3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="farm-introduction-probability" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="farm-introduction-probability"><span class="header-section-number">12</span> Farm Introduction Probability</h2>
<p>Comparing particle probability estimates for simulated farm locations.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>farm_intro_probs <span class="ot">&lt;-</span> <span class="fu">extract_farm_estimates</span>(<span class="at">model =</span> bin_gamma_model,</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">stack =</span> joint.stack,</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">stack_targ =</span> <span class="st">"dens.0"</span>,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">match_data =</span> comb_data_in)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="probability-at-farms" class="level3">
<h3 class="anchored" data-anchor-id="probability-at-farms">Probability at farms</h3>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>farm_intro_probs<span class="sc">$</span>plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="simulate_outbreak_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Filtering to simulated farms with at least a 50/% chance of particle occurrence.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>exposed_farms <span class="ot">&lt;-</span> farm_intro_probs<span class="sc">$</span>table <span class="sc">%&gt;%</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(med <span class="sc">&gt;=</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> name <span class="sc">!=</span> <span class="st">"source_farm"</span>) <span class="co"># 50% chance or higher</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>exposed_farms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: left;">label</th>
<th style="text-align: right;">low</th>
<th style="text-align: right;">med</th>
<th style="text-align: right;">high</th>
<th style="text-align: right;">flock</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">farm_18</td>
<td style="text-align: left;">Farm 18</td>
<td style="text-align: right;">0.9823</td>
<td style="text-align: right;">0.9854</td>
<td style="text-align: right;">0.9868</td>
<td style="text-align: right;">22574</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
</section>
<section id="secondary-outbreak" class="level2" data-number="13">
<h2 data-number="13" class="anchored" data-anchor-id="secondary-outbreak"><span class="header-section-number">13</span> Secondary Outbreak</h2>
<p>Given the high probability of particle introduction at a farm another than the <em>source_farm</em>, approximate how an outbreak might unfold based on that farm’s flock size, timeline of introduction, and other characteristics.</p>
<section id="seir-model-for-secondary-ourbreak" class="level3">
<h3 class="anchored" data-anchor-id="seir-model-for-secondary-ourbreak">SEIR model for secondary ourbreak</h3>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>infect_date <span class="ot">&lt;-</span> <span class="fu">as_date</span>(simulated_realease_dt)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>intro_farm_args <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta       =</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>beta,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">sigma      =</span> <span class="dv">1</span> <span class="sc">/</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>sigma,</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma      =</span> <span class="dv">1</span> <span class="sc">/</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>gamma,</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">qV         =</span> cfg<span class="sc">$</span>virus<span class="sc">$</span>qV,</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Vh         =</span> cfg<span class="sc">$</span>poultry<span class="sc">$</span>house_vol,</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Q          =</span> cfg<span class="sc">$</span>poultry<span class="sc">$</span>Q_m3_h <span class="sc">*</span> <span class="dv">24</span>,</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">lamd       =</span> <span class="fu">log</span>(<span class="dv">2</span>) <span class="sc">/</span> halflife,</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">flock_size =</span> exposed_farms<span class="sc">$</span>flock, <span class="co"># flock size where virus introduced</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ei         =</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>Ei,</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ii         =</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>Ii,</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ri         =</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>Ri,</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">Vi         =</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>Vi,</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">sim_days   =</span> cfg<span class="sc">$</span>seir<span class="sc">$</span>sim_days,</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">infect_date =</span> infect_date <span class="co"># infection same day as emission (only hours difference)</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>seir_exposed_farm <span class="ot">&lt;-</span> <span class="fu">do.call</span>(model_seir_shedding, intro_farm_args)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Outbreak at exposed farm. For <code>rand_detect_day</code>, assuming detection occurs 5 to 20 days after outbreaks start. That is, when workers notice that death rates are exceeding the normal background rate.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1976</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>rand_detect_day <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">20</span>),<span class="dv">0</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>detection_date <span class="ot">&lt;-</span> infect_date <span class="sc">+</span> <span class="fu">days</span>(rand_detect_day)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="view-outbreak-dynamics" class="level3">
<h3 class="anchored" data-anchor-id="view-outbreak-dynamics">View outbreak dynamics</h3>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_ode_shed_dynamics</span>(seir_exposed_farm, <span class="at">date_axis =</span> <span class="cn">TRUE</span>, <span class="at">vline =</span> detection_date, <span class="at">vline_text =</span> <span class="st">"Detection"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="simulate_outbreak_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid" width="960"></p>
</div>
</div>
</section>
</section>
<section id="write-simulation-result" class="level2" data-number="14">
<h2 data-number="14" class="anchored" data-anchor-id="write-simulation-result"><span class="header-section-number">14</span> Write Simulation Result</h2>
<p>Recording outbreak simulation info to be used in downstream analysis.</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>farms_wgs84 <span class="ot">&lt;-</span> <span class="fu">project</span>(study_area<span class="sc">$</span>farm_locs, <span class="st">"EPSG:4326"</span>) <span class="co"># long/lat</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>simulation_keep <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(farms_wgs84, <span class="at">geom=</span><span class="st">"xy"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">outbreak =</span> <span class="fu">if_else</span>(name <span class="sc">==</span> exposed_farms<span class="sc">$</span>name, detection_date,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>         <span class="fu">if_else</span>(name <span class="sc">==</span> <span class="st">"source_farm"</span>, sim_dates<span class="sc">$</span>release_date, <span class="cn">NA</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Write copies locally and on OSF</p>
<div class="cell">
<details open="">
<summary>Hide code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># local copy</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(simulation_keep, <span class="fu">here</span>(<span class="st">"local/assets/demo_outbreak_sim_2025-04-28.csv"</span>))</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co"># copy to OSF for others to access</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="fu">osf_upload</span>(osf_project_demo, <span class="at">path =</span> <span class="fu">here</span>(<span class="st">"local/assets/demo_outbreak_sim_2025-04-28.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="closing" class="level2" data-number="15">
<h2 data-number="15" class="anchored" data-anchor-id="closing"><span class="header-section-number">15</span> Closing</h2>
<p>This script simulated a pathogen plume from a source farm location followed secondary outbreaks at other farms downwind. Next, the results here are analysed in the <a href="https://geoepi.github.io/EpiPlume/trace_emission_source.html">script linked here</a> to determine if that outbreak can be traced back to the original source farm. ```</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-right">Built with <a href="https://quarto.org/">Quarto</a></div>
  </div>
</footer>



<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>